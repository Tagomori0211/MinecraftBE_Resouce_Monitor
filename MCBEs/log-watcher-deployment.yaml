apiVersion: v1
kind: ConfigMap
metadata:
  name: log-watcher-script
  namespace: default
data:
  main.py: |
    import time
    import re
    import sys
    from kubernetes import client, config, watch
    from kubernetes.client.rest import ApiException
    from prometheus_client import start_http_server, Gauge

    # --- Prometheus Metrics ---
    PLAYER_ONLINE_STATUS = Gauge(
        'minecraft_player_online_status',
        'Current online status of the player (1 for online, 0 for offline)',
        ['user_name']
    )

    # --- Log Parsing Logic (Updated) ---
    def parse_log_line(line):
        # Format: Player connected: Name, xuid: ...
        login_pattern = r"Player connected: (.+), xuid"
        logout_pattern = r"Player disconnected: (.+), xuid"
        
        match_login = re.search(login_pattern, line)
        if match_login: 
            return 'LOGIN', match_login.group(1).strip()
        
        match_logout = re.search(logout_pattern, line)
        if match_logout: 
            return 'LOGOUT', match_logout.group(1).strip()
        
        return None, None

    # --- K8s Logic ---
    def get_minecraft_pod(v1, namespace, label_selector):
        try:
            pods = v1.list_namespaced_pod(namespace, label_selector=label_selector)
            for pod in pods.items:
                if pod.status.phase == "Running": return pod.metadata.name
        except ApiException as e:
            print(f"Error listing pods: {e}")
        return None

    def watch_logs():
        try:
            config.load_incluster_config()
        except Exception:
            print("Failed to load in-cluster config")
            sys.exit(1)

        v1 = client.CoreV1Api()
        w = watch.Watch()
        NAMESPACE = "default"
        POD_LABEL_SELECTOR = "app=minecraft-bedrock"

        print("üöÄ Minecraft Log Exporter started on port 8000")

        while True:
            pod_name = get_minecraft_pod(v1, NAMESPACE, POD_LABEL_SELECTOR)
            if not pod_name:
                print("‚è≥ Pod not found. Retrying in 10s...")
                time.sleep(10)
                continue

            print(f"TARGET POD: {pod_name}. Streaming...")
            try:
                # „ÄêÈáçË¶Å„Äë„Ç≥„É≥„ÉÜ„ÉäÂêç "minecraft" „ÇíÊåáÂÆö
                for line in w.stream(v1.read_namespaced_pod_log, name=pod_name, namespace=NAMESPACE, container="minecraft", follow=True):
                    event, user = parse_log_line(line.strip())
                    if event == 'LOGIN':
                        print(f"‚úÖ LOGIN: {user}")
                        PLAYER_ONLINE_STATUS.labels(user_name=user).set(1)
                    elif event == 'LOGOUT':
                        print(f"üö™ LOGOUT: {user}")
                        PLAYER_ONLINE_STATUS.labels(user_name=user).set(0)
            except Exception as e:
                print(f"‚ö†Ô∏è Stream Error: {e}. Reconnecting...")
                time.sleep(5)

    if __name__ == '__main__':
        start_http_server(8000)
        watch_logs()

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: log-watcher
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: log-watcher
  template:
    metadata:
      labels:
        app: log-watcher
    spec:
      serviceAccountName: log-watcher-sa # RBACÂøÖÈ†à
      containers:
        - name: log-watcher
          image: python:3.9-slim
          # „É©„Ç§„Éñ„É©„É™„Ç§„É≥„Çπ„Éà„Éº„É´„Å®„Çπ„ÇØ„É™„Éó„ÉàÂÆüË°å
          command: ["/bin/sh", "-c"]
          args: ["pip install --no-cache-dir kubernetes prometheus-client && python -u /app/main.py"]
          ports:
            - containerPort: 8000
          env:
            - name: TZ
              value: "Asia/Tokyo"
          volumeMounts:
            - name: script-volume
              mountPath: /app
      volumes:
        - name: script-volume
          configMap:
            name: log-watcher-script

---
apiVersion: v1
kind: Service
metadata:
  name: log-watcher-svc
  namespace: default
spec:
  type: NodePort
  selector:
    app: log-watcher
  ports:
    - protocol: TCP
      port: 8000
      targetPort: 8000
      nodePort: 30003